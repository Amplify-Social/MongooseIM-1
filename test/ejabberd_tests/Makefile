.PHONY: all test console compile
all: test

TESTSPEC ?= default.spec
PRESET   ?= all
PREPARE  ?= prepare

test_clean: get-deps
	rm -rf tests/*.beam
	make test

cover_test_clean: get-deps
	rm -rf tests/*.beam
	make cover_test

quicktest_pubsub: $(PREPARE) set_pubsub_spec quicktest

set_pubsub_spec:
	$(eval TESTSPEC = pubsub.spec)

quicktest: $(PREPARE)
	erl -noinput -sname test -setcookie ejabberd \
		-pa `pwd`/tests \
		    `pwd`/ebin \
			`pwd`/deps/*/ebin \
			`pwd`/deps/platypus/apps/*/ebin \
		$(ADD_OPTS) \
		-s run_common_test main test=quick spec=$(TESTSPEC)

cover_quicktest: $(PREPARE)
	erl -noinput -sname test -setcookie ejabberd \
		-pa `pwd`/tests \
		    `pwd`/ebin \
			`pwd`/deps/*/ebin \
			`pwd`/deps/platypus/apps/*/ebin \
		$(ADD_OPTS) \
		-s run_common_test main test=quick spec=$(TESTSPEC) cover=true

test_preset: $(PREPARE)
	erl -noinput -sname test -setcookie ejabberd \
		-pa `pwd`/tests \
		    `pwd`/ebin \
			`pwd`/deps/*/ebin \
			`pwd`/deps/platypus/apps/*/ebin \
		$(ADD_OPTS) \
		-s run_common_test main test=full spec=$(TESTSPEC) preset=$(PRESET)

cover_test_preset: $(PREPARE)
	erl -noinput -sname test -setcookie ejabberd \
		-pa `pwd`/tests \
		    `pwd`/ebin \
			`pwd`/deps/*/ebin \
			`pwd`/deps/platypus/apps/*/ebin \
		$(ADD_OPTS) \
		-s run_common_test main test=full spec=$(TESTSPEC) preset=$(PRESET) cover=true

test: $(PREPARE)
	erl -noinput -sname test -setcookie ejabberd \
		-pa `pwd`/tests \
		    `pwd`/ebin \
			`pwd`/deps/*/ebin \
			`pwd`/deps/platypus/apps/*/ebin \
		$(ADD_OPTS) \
		-s run_common_test main test=full spec=$(TESTSPEC)

cover_test: $(PREPARE)
	erl -noinput -sname test -setcookie ejabberd \
		-pa `pwd`/tests \
		    `pwd`/ebin \
			`pwd`/deps/*/ebin \
			`pwd`/deps/platypus/apps/*/ebin \
		$(ADD_OPTS) \
		-s run_common_test main test=full spec=$(TESTSPEC) cover=true

prepare: compile
	erlc -Ideps/exml/include \
		 run_common_test.erl
	mkdir -p ct_report

console: compile
	erl -sname test -setcookie ejabberd \
		-pa `pwd`/tests \
		    `pwd`/ebin \
			`pwd`/deps/*/ebin \
			`pwd`/deps/platypus/apps/*/ebin \

compile: get-deps
	./rebar compile

get-deps:
	./rebar get-deps

clean:
	rm -rf tests/*.beam
	./rebar clean

